<?php

namespace DataKit\DataViews\Field;

use InvalidArgumentException;

/**
 * A field that represents a status indicator.
 *
 * @since $ver$
 */
final class StatusIndicatorField extends Field {
	/**
	 * The indicator types.
	 *
	 * @since $ver$
	 */
	private const TYPE_BOOLEAN = 'boolean';
	private const TYPE_MAPPING = 'mapping';

	/**
	 * The indicator statuses.
	 *
	 * @since $ver$
	 */
	public const STATUS_ACTIVE = 'active';
	public const STATUS_INACTIVE = 'inactive';
	public const STATUS_INFO = 'info';
	public const STATUS_WARNING = 'warning';
	public const STATUS_ERROR = 'error';

	/**
	 * The default labels per status.
	 *
	 * @since $ver$
	 * @var array|string[]
	 */
	private array $labels = [
		self::STATUS_ACTIVE   => 'Active',
		self::STATUS_INACTIVE => 'Inactive',
		self::STATUS_INFO     => 'Info',
		self::STATUS_WARNING  => 'Warning',
		self::STATUS_ERROR    => 'Error',
	];

	/**
	 * The indicator type.
	 *
	 * @since $ver$
	 * @var string
	 */
	private string $type = self::TYPE_BOOLEAN;

	/**
	 * Whether the indicator has a dot.
	 *
	 * @since $ver$
	 * @var bool
	 */
	private bool $has_dot = true;

	/**
	 * Whether the indicator is a pill.
	 *
	 * @since $ver$
	 * @var bool
	 */
	private bool $is_pill = true;

	/**
	 * Whether to use the value as the indicator label.
	 *
	 * @since $ver$
	 * @var bool
	 */
	private bool $use_value_as_label = false;

	/**
	 * The boolean status mapping.
	 *
	 * @since $ver$
	 * @var array|string[]
	 */
	private array $boolean_statuses = [ 0 => self::STATUS_INACTIVE, 1 => self::STATUS_ACTIVE ];

	/**
	 * The mapping from value to a status type.
	 *
	 * @since $ver$
	 * @var array
	 */
	private array $mapping = [];

	/**
	 * @inheritDoc
	 * @since $ver$
	 */
	protected string $render = 'datakit_fields.html';

	/**
	 * Returns an instance with a (possible) dot.
	 *
	 * @since $ver$
	 *
	 * @param bool $has_dot Whether the instance has a dot.
	 *
	 * @return self The field.
	 */
	public function dot( bool $has_dot ) : self {
		$clone          = clone $this;
		$clone->has_dot = $has_dot;

		return $clone;
	}

	/**
	 * Returns an instance with as a (possible) pill.
	 *
	 * @since $ver$
	 *
	 * @param bool $is_pill Whether the instance is a pill.
	 *
	 * @return self The field.
	 */
	public function pill( bool $is_pill ) : self {
		$clone          = clone $this;
		$clone->is_pill = $is_pill;

		return $clone;
	}

	/**
	 * Returns an instance with mapping type.
	 *
	 * @since $ver$
	 *
	 * @param string      $active   The value to use as Active.
	 * @param string|null $inactive The value to use as inactive.
	 * @param string|null $error    The value to use as an error.
	 * @param string|null $warning  The value to use as a warning.
	 * @param string|null $info     The value to use as informative.
	 *
	 * @return self The field.
	 */
	public function mapping(
		string $active,
		?string $inactive = null,
		?string $error = null,
		?string $warning = null,
		?string $info = null
	) : self {
		$clone          = clone $this;
		$clone->type    = self::TYPE_MAPPING;
		$clone->mapping = array_flip( array_filter( compact( 'active', 'inactive', 'error', 'warning', 'info' ) ) );

		return $clone;
	}

	/**
	 * Returns an instance with mapping type.
	 *
	 * @since $ver$
	 *
	 * @param string $true  The status used for a truthy value.
	 * @param string $false The status used for a false value.
	 *
	 * @return self The field.
	 */
	public function boolean( string $true = self::STATUS_ACTIVE, string $false = self::STATUS_INACTIVE ) : self {
		$clone       = clone $this;
		$clone->type = self::TYPE_BOOLEAN;

		$clone->boolean_statuses[1] = $this->validate_status( $true );
		$clone->boolean_statuses[0] = $this->validate_status( $false );

		return $clone;
	}

	/**
	 * Returns the status type.
	 *
	 * @since $ver$
	 *
	 * @param mixed $value The value to check.
	 *
	 * @return string The status type.
	 */
	private function status( $value ) : string {
		if ( self::TYPE_BOOLEAN === $this->type ) {
			return $this->boolean_statuses[ (bool) $value ];
		}

		if ( self::TYPE_MAPPING === $this->type ) {
			return $this->mapping[ $value ] ?? self::STATUS_INACTIVE;
		}

		return self::STATUS_INACTIVE;
	}

	/**
	 * @inheritDoc
	 * @since $ver$
	 */
	public function get_value( array $data ) {
		$value   = parent::get_value( $data );
		$classes = [
			sprintf( 'datakit-status-indicator--%s', $this->status( $value ) ),
		];

		$svg = '';

		if ( $this->is_pill ) {
			$classes[] = 'datakit-status-indicator--is-pill';
		}
		if ( $this->has_dot ) {
			$classes[] = 'datakit-status-indicator--has-dot';
			$svg       = '<svg viewBox="0 0 6 6" xmlns="http://www.w3.org/2000/svg"><circle cx="3" cy="2" r="1" stroke-width="2"></circle></svg>';
		}

		$status = $this->get_label( (string) $value );

		return sprintf(
			'<span class="datakit-status-indicator %s">%s<span class="datakit-status-indicator-status">%s</span></span>',
			implode( ' ', $classes ),
			$svg,
			$status,
		);
	}

	/**
	 * Returns the label for the indicator.
	 *
	 * @since $ver$
	 *
	 * @param string $value The value.
	 *
	 * @return string The value.
	 */
	private function get_label( string $value ) : string {
		if ( $this->use_value_as_label ) {
			return $value ?: '&nbsp;';
		}

		return $this->labels[ $this->status( $value ) ];
	}

	/**
	 * Validates a provided status.
	 *
	 * @since $ver$
	 *
	 * @param string $status The status.
	 *
	 * @return string The status text.
	 */
	private function validate_status( string $status ) : string {
		if ( ! in_array(
			$status,
			$statuses = [
				self::STATUS_INACTIVE,
				self::STATUS_ACTIVE,
				self::STATUS_ERROR,
				self::STATUS_WARNING,
				self::STATUS_INFO,
			],
			true,
		) ) {
			throw new InvalidArgumentException( sprintf(
				'A status can only be one of: "%s"; "%s" given. ',
				implode( '", "', $statuses ),
				$status,
			) );
		}

		return $status;
	}
}
